<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÆON | Studio</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Specifické pro admin */
        body { overflow-y: auto; display: block; padding-bottom: 50px; }
        
        .social-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;
        }
        .social-icon-btn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px; height: 50px; cursor: pointer; color: var(--text-main);
            font-size: 20px; display: flex; justify-content: center; align-items: center;
            transition: 0.2s;
        }
        .social-icon-btn:hover { background: var(--accent); color: black; border-color: transparent; }
        
        .active-social-row {
            display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.3);
            padding: 10px; border-radius: 10px; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.1);
            animation: fadeIn 0.3s ease;
        }
        .social-prefix {
            font-size: 10px; color: #888; white-space: nowrap; font-family: monospace;
        }
        .social-input {
            background: transparent; border: none; color: white; width: 100%; outline: none; font-weight: bold;
        }
        .remove-social {
            color: #ff4757; cursor: pointer; padding: 5px; font-size: 14px;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="fixed-background">
        <div class="orb orb-1"></div><div class="orb orb-2"></div>
        <div class="orb orb-3"></div><div class="orb orb-4"></div>
    </div>

    <div class="admin-container">
        <h1 style="color: var(--text-main); text-align: center;">ÆON Studio</h1>
        <div id="loading" style="text-align:center; color:var(--accent); font-size: 12px;">NAČÍTÁM DATA...</div>

        <label class="admin-label">URL (Slug)</label>
        <input type="text" class="admin-input" id="slug" placeholder="např. ondra" required>

        <label class="admin-label">Vyber Atmosféru</label>
        <div class="theme-grid" id="themeGrid"></div>
        <input type="hidden" id="selectedTheme" value="winter-night">

        <label class="admin-label">Identita</label>
        <input type="text" class="admin-input" id="name" placeholder="Jméno">
        <input type="text" class="admin-input" id="bio" placeholder="Bio / Titul" style="margin-top:5px;">
        <input type="text" class="admin-input" id="motto" placeholder="Motto" style="margin-top:5px;">

        <label class="admin-label">Avatar</label>
        <div class="avatar-grid" id="avatarStudio"></div>
        <div style="text-align:center; font-size:10px; color:var(--text-main); opacity:0.7; margin: 5px 0;">NEBO NAHRAJ VLASTNÍ</div>
        <input type="file" id="photoInput" accept="image/*" style="color: var(--text-main);">
        <input type="hidden" id="base64String">
        <img id="preview" style="width:50px; height:50px; border-radius:50%; margin: 10px auto; display:block; object-fit:cover; border: 2px solid var(--accent);">

        <label class="admin-label">Social Hub (Klikni a přidej)</label>
        <div class="social-grid">
            <button class="social-icon-btn" onclick="addSocial('instagram')" title="Instagram"><i class="fab fa-instagram"></i></button>
            <button class="social-icon-btn" onclick="addSocial('facebook')" title="Facebook"><i class="fab fa-facebook-f"></i></button>
            <button class="social-icon-btn" onclick="addSocial('tiktok')" title="TikTok"><i class="fab fa-tiktok"></i></button>
            <button class="social-icon-btn" onclick="addSocial('youtube')" title="YouTube"><i class="fab fa-youtube"></i></button>
            <button class="social-icon-btn" onclick="addSocial('twitter')" title="X (Twitter)"><i class="fab fa-x-twitter"></i></button>
            <button class="social-icon-btn" onclick="addSocial('linkedin')" title="LinkedIn"><i class="fab fa-linkedin-in"></i></button>
            <button class="social-icon-btn" onclick="addSocial('twitch')" title="Twitch"><i class="fab fa-twitch"></i></button>
            <button class="social-icon-btn" onclick="addSocial('discord')" title="Discord"><i class="fab fa-discord"></i></button>
            <button class="social-icon-btn" onclick="addSocial('pinterest')" title="Pinterest"><i class="fab fa-pinterest"></i></button>
            <button class="social-icon-btn" onclick="addSocial('reddit')" title="Reddit"><i class="fab fa-reddit-alien"></i></button>
            <button class="social-icon-btn" onclick="addSocial('snapchat')" title="Snapchat"><i class="fab fa-snapchat"></i></button>
            <button class="social-icon-btn" onclick="addSocial('threads')" title="Threads"><i class="fa-solid fa-at"></i></button>
        </div>

        <div id="activeSocialsContainer"></div>

        <label class="admin-label">Jiné Odkazy (Web, Portfolio...)</label>
        <div id="linksContainer"></div>
        <button onclick="addLinkField()" style="background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; color: var(--text-main); cursor: pointer; margin-top:10px; width:100%;">+ Vlastní odkaz</button>

        <button onclick="saveCard()" id="saveBtn" style="background: var(--accent); border: none; padding: 16px; color: #000; font-weight: bold; border-radius: 12px; margin-top: 20px; cursor: pointer; width: 100%;">ULOŽIT KARTU</button>
        <div id="status" style="text-align:center; margin-top:10px; color: yellow; text-shadow: 0 1px 2px black; font-weight:bold;"></div>
    </div>

    <script>
        // --- KONFIGURACE SÍTÍ ---
        const platforms = {
            instagram: { icon: 'fa-instagram', prefix: 'instagram.com/', url: 'https://instagram.com/', label: 'Instagram' },
            facebook: { icon: 'fa-facebook-f', prefix: 'facebook.com/', url: 'https://facebook.com/', label: 'Facebook' },
            tiktok: { icon: 'fa-tiktok', prefix: 'tiktok.com/@', url: 'https://tiktok.com/@', label: 'TikTok' },
            youtube: { icon: 'fa-youtube', prefix: 'youtube.com/@', url: 'https://youtube.com/@', label: 'YouTube' },
            twitter: { icon: 'fa-x-twitter', prefix: 'x.com/', url: 'https://x.com/', label: 'X' },
            linkedin: { icon: 'fa-linkedin-in', prefix: 'linkedin.com/in/', url: 'https://linkedin.com/in/', label: 'LinkedIn' },
            twitch: { icon: 'fa-twitch', prefix: 'twitch.tv/', url: 'https://twitch.tv/', label: 'Twitch' },
            discord: { icon: 'fa-discord', prefix: 'discord.gg/', url: 'https://discord.gg/', label: 'Discord Invite' },
            pinterest: { icon: 'fa-pinterest', prefix: 'pinterest.com/', url: 'https://pinterest.com/', label: 'Pinterest' },
            reddit: { icon: 'fa-reddit-alien', prefix: 'reddit.com/user/', url: 'https://reddit.com/user/', label: 'Reddit' },
            snapchat: { icon: 'fa-snapchat', prefix: 'snapchat.com/add/', url: 'https://snapchat.com/add/', label: 'Snapchat' },
            threads: { icon: 'fa-at', prefix: 'threads.net/@', url: 'https://threads.net/@', label: 'Threads' }
        };

        // --- Zbytek logiky (Témata, Avataři) ---
        const themes = [
            { id: "spring-morning", name: "Jaro Ráno", bg: "#f3ffe3" }, { id: "spring-noon", name: "Jaro Poledne", bg: "#badc58" },
            { id: "spring-evening", name: "Jaro Večer", bg: "#e056fd", dark:true }, { id: "spring-night", name: "Jaro Noc", bg: "#2c3a47", dark:true },
            { id: "summer-morning", name: "Léto Ráno", bg: "#81ecec" }, { id: "summer-noon", name: "Léto Poledne", bg: "#f9ca24" },
            { id: "summer-evening", name: "Léto Večer", bg: "#eb4d4b", dark:true }, { id: "summer-night", name: "Léto Noc", bg: "#130f40", dark:true },
            { id: "autumn-morning", name: "Podzim Ráno", bg: "#d1ccc0" }, { id: "autumn-noon", name: "Podzim Poledne", bg: "#ffdbcc" },
            { id: "autumn-evening", name: "Podzim Večer", bg: "#e17055", dark:true }, { id: "autumn-night", name: "Podzim Noc", bg: "#2d3436", dark:true },
            { id: "winter-morning", name: "Zima Ráno", bg: "#dfe4ea" }, { id: "winter-noon", name: "Zima Poledne", bg: "#bbdefb" },
            { id: "winter-evening", name: "Zima Večer", bg: "#a29bfe", dark:true }, { id: "winter-night", name: "Zima Noc", bg: "#0c2461", dark:true }
        ];

        const themeContainer = document.getElementById('themeGrid');
        themes.forEach(t => {
            const div = document.createElement('div');
            div.className = 'theme-btn' + (t.dark ? ' dark-text' : '');
            div.innerText = t.name; div.style.background = t.bg;
            div.onclick = () => selectTheme(t.id, div);
            themeContainer.appendChild(div);
        });

        function selectTheme(id, el) {
            document.getElementById('selectedTheme').value = id;
            document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            document.body.className = ''; 
            const parts = id.split('-'); document.body.classList.add(parts[0]); document.body.classList.add(parts[1]);
        }

        const seeds = ["Leo", "Mila", "Caleb", "Eliza", "Chase", "Jade", "Nora", "Jack", "Felix", "Ruby"];
        const avContainer = document.getElementById('avatarStudio');
        seeds.forEach(s => {
            const img = document.createElement('img');
            const url = `https://api.dicebear.com/7.x/notionists/svg?seed=${s}&backgroundColor=transparent`;
            img.src = url; img.className = 'avatar-option';
            img.onclick = () => {
                document.getElementById('base64String').value = url;
                document.getElementById('preview').src = url;
                document.querySelectorAll('.avatar-option').forEach(x => x.classList.remove('selected'));
                img.classList.add('selected');
            };
            avContainer.appendChild(img);
        });

        // --- SOCIAL LOGIC ---
        const activeSocialsDiv = document.getElementById('activeSocialsContainer');

        function addSocial(type, value = "") {
            // Zkontrolujeme, jestli už tam není (abychom neměli 2x Instagram)
            if(document.querySelector(`.social-input[data-type="${type}"]`)) return;

            const p = platforms[type];
            const div = document.createElement('div');
            div.className = 'active-social-row';
            div.innerHTML = `
                <i class="fab ${p.icon}" style="font-size:18px; width:20px; text-align:center;"></i>
                <div style="flex-grow:1;">
                    <span class="social-prefix">${p.prefix}</span>
                    <input class="social-input" type="text" placeholder="username" data-type="${type}" value="${value}">
                </div>
                <i class="fas fa-times remove-social" onclick="this.parentElement.remove()"></i>
            `;
            activeSocialsDiv.appendChild(div);
        }

        const linksWrapper = document.getElementById('linksContainer');
        function addLinkField(l="", u="") {
            const d = document.createElement('div'); d.className = 'link-row';
            d.innerHTML = `<input class="admin-input l-lbl" placeholder="Název (např. Web)" value="${l}" style="width:40%"> <input class="admin-input l-url" placeholder="https://..." value="${u}" style="width:60%"> <i class="fas fa-times remove-social" style="margin-top:10px;" onclick="this.parentElement.remove()"></i>`;
            linksWrapper.appendChild(d);
        }

        // --- LOAD ---
        window.onload = async function() {
            const params = new URLSearchParams(window.location.search);
            const slug = params.get('slug');
            if(slug) {
                document.getElementById('slug').value = slug;
                document.getElementById('saveBtn').innerText = "AKTUALIZOVAT";
                try {
                    const res = await fetch(`/api/aeon-api?slug=${slug}`);
                    if(res.ok) {
                        const d = await res.json();
                        document.getElementById('name').value = d.name || "";
                        document.getElementById('bio').value = d.bio || "";
                        document.getElementById('motto').value = d.motto || "";
                        
                        if(d.theme) {
                            const btn = Array.from(document.querySelectorAll('.theme-btn')).find(b => b.innerText.includes(d.theme.split('-')[1].charAt(0).toUpperCase())); 
                            selectTheme(d.theme, btn || document.createElement('div'));
                        } else { selectTheme('winter-night', document.createElement('div')); }

                        if(d.avatar) { document.getElementById('base64String').value = d.avatar; document.getElementById('preview').src = d.avatar; }
                        
                        // Načtení odkazů a jejich roztřídění
                        activeSocialsDiv.innerHTML = '';
                        linksWrapper.innerHTML = '';
                        
                        if(d.links) {
                            d.links.forEach(x => {
                                // Zkusíme zjistit, jestli to je známá soc. síť
                                let found = false;
                                for (const [key, p] of Object.entries(platforms)) {
                                    if (x.url.startsWith(p.url)) {
                                        // Je to soc. síť! Ořízneme URL a získáme username
                                        const username = x.url.replace(p.url, '');
                                        addSocial(key, username);
                                        found = true;
                                        break;
                                    }
                                }
                                // Pokud to není soc. síť, je to custom odkaz
                                if (!found) addLinkField(x.label, x.url);
                            });
                        }
                    }
                } catch(e){}
            } else { selectTheme('winter-night', document.createElement('div')); }
            document.getElementById('loading').style.display = 'none';
        }

        // --- SAVE ---
        async function saveCard() {
            const stat = document.getElementById('status'); stat.innerText = "Ukládám...";
            const slug = document.getElementById('slug').value.toLowerCase().replace(/\s+/g, '-');
            const links = [];

            // 1. Sesbíráme Socials a vyrobíme z nich URL
            document.querySelectorAll('.active-social-row').forEach(row => {
                const input = row.querySelector('.social-input');
                const type = input.getAttribute('data-type');
                const val = input.value.trim();
                if(val) {
                    // Automaticky přidáme správný prefix (https://instagram.com/...)
                    let finalUrl = platforms[type].url + val.replace('@', ''); // Odstraníme @ kdyby ji tam uživatel napsal
                    links.push({ label: platforms[type].label, url: finalUrl });
                }
            });

            // 2. Sesbíráme Custom Odkazy
            document.querySelectorAll('.link-row').forEach(r => {
                const l = r.querySelector('.l-lbl').value; const u = r.querySelector('.l-url').value;
                if(l && u) links.push({label: l, url: u});
            });

            const payload = {
                data: {
                    slug: slug, name: document.getElementById('name').value,
                    bio: document.getElementById('bio').value, motto: document.getElementById('motto').value,
                    theme: document.getElementById('selectedTheme').value,
                    avatar: document.getElementById('base64String').value, links: links
                }
            };

            try {
                await fetch('/api/aeon-api', { method: 'POST', body: JSON.stringify(payload) });
                stat.innerText = "HOTOVO!"; stat.style.color = "#0f0";
                setTimeout(() => window.location.href = `/?slug=${slug}`, 1500);
            } catch(e) { stat.innerText = "CHYBA"; }
        }

        document.getElementById('photoInput').addEventListener('change', function(e) {
            const file = e.target.files[0]; if(!file) return;
            const r = new FileReader();
            r.onload = function(ev) {
                const i = new Image(); i.onload = function() {
                    const c = document.createElement('canvas'); const x = c.getContext('2d');
                    const m = 500; let w=i.width, h=i.height;
                    if(w>h){if(w>m){h*=m/w;w=m}}else{if(h>m){w*=m/h;h=m}}
                    c.width=w; c.height=h; x.drawImage(i,0,0,w,h);
                    const d = c.toDataURL('image/jpeg',0.8);
                    document.getElementById('preview').src=d; document.getElementById('base64String').value=d;
                }; i.src = ev.target.result;
            }; r.readAsDataURL(file);
        });
    </script>
</body>
</html>