<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÆON | Studio</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Specifické úpravy pro Admin */
        body { overflow-y: auto; display: block; padding-bottom: 50px; }
        .social-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        
        .social-icon-btn {
            background: var(--input-bg); border: 1px solid var(--border);
            border-radius: 12px; height: 50px; cursor: pointer; color: var(--text-main);
            font-size: 20px; display: flex; justify-content: center; align-items: center; transition: 0.2s;
        }
        .social-icon-btn:hover { background: var(--accent); color: #000; border-color: transparent; }
        
        .active-social-row {
            display: flex; align-items: center; gap: 8px; background: var(--input-bg);
            padding: 8px 12px; border-radius: 10px; margin-bottom: 8px; border: 1px solid var(--border);
            color: var(--text-main); animation: fadeIn 0.3s ease;
        }
        .active-social-row.valid { border-color: #00ff88; box-shadow: 0 0 5px rgba(0, 255, 136, 0.2); }
        .active-social-row.invalid { border-color: #ff4757; box-shadow: 0 0 5px rgba(255, 71, 87, 0.2); }

        .input-wrapper { flex-grow: 1; display: flex; align-items: center; overflow: hidden; }
        .social-prefix { font-size: 11px; color: var(--text-main); opacity: 0.6; white-space: nowrap; font-family: monospace; margin-right: 4px; }
        .active-social-row.mode-url .social-prefix { display: none; }
        .social-input { background: transparent; border: none; color: var(--text-main); width: 100%; outline: none; font-weight: bold; font-size: 14px; }
        
        .action-group { display: flex; gap: 4px; }
        .mini-btn { width: 28px; height: 28px; border-radius: 6px; border: none; background: rgba(128,128,128,0.2); color: var(--text-main); opacity: 0.7; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; transition: 0.2s; }
        .mini-btn:hover { background: var(--accent); color: #000; opacity: 1; }
        .mini-btn.active { color: var(--accent); background: rgba(0,0,0,0.5); border: 1px solid var(--accent); opacity: 1; }
        
        /* Tooltip */
        .help-tooltip { position: absolute; bottom: 35px; right: 0; width: 280px; background: #111; border: 1px solid rgba(255,255,255,0.2); color: #ddd; padding: 12px; border-radius: 8px; z-index: 100; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-size: 11px; }
        .mini-btn:hover .help-tooltip { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="lang-switcher">
        <div class="lang-btn" onclick="setLanguage('cs')" id="lang-cs">
            <img src="https://flagcdn.com/w40/cz.png" alt="CZ">
        </div>
        <div class="lang-btn" onclick="setLanguage('en')" id="lang-en">
            <img src="https://flagcdn.com/w40/gb.png" alt="EN">
        </div>
    </div>

    <div class="fixed-background">
        <div class="orb orb-1"></div><div class="orb orb-2"></div><div class="orb orb-3"></div><div class="orb orb-4"></div>
    </div>

    <div class="admin-container">
        <h1 style="color: var(--text-main); text-align: center;">ÆON Studio</h1>
        <div id="loading" style="text-align:center; color:var(--accent); font-size: 12px;">LOADING...</div>

        <label class="admin-label" data-i18n="slug_label">URL (Slug)</label>
        <input type="text" class="admin-input" id="slug" placeholder="e.g. john-doe" required>

        <label class="admin-label" data-i18n="theme_label">Choose Atmosphere</label>
        <div class="theme-grid" id="themeGrid"></div>
        <input type="hidden" id="selectedTheme" value="winter-night">

        <label class="admin-label" data-i18n="identity_label">Identity</label>
        <input type="text" class="admin-input" id="name" placeholder="Name">
        <input type="text" class="admin-input" id="bio" placeholder="Bio / Job Title" style="margin-top:5px;">
        <input type="text" class="admin-input" id="motto" placeholder="Motto" style="margin-top:5px;">

        <label class="admin-label" data-i18n="avatar_label">Avatar</label>
        <div class="avatar-grid" id="avatarStudio"></div>
        <div style="text-align:center; font-size:10px; color:var(--text-main); opacity:0.7; margin: 5px 0;" data-i18n="avatar_upload">OR UPLOAD YOUR OWN</div>
        <input type="file" id="photoInput" accept="image/*" style="color: var(--text-main);">
        <input type="hidden" id="base64String">
        <img id="preview" style="width:50px; height:50px; border-radius:50%; margin: 10px auto; display:block; object-fit:cover; border: 2px solid var(--accent);">

        <label class="admin-label" data-i18n="social_label">Social Hub</label>
        <div class="social-grid" id="socialGrid">
            </div>
        <div id="activeSocialsContainer"></div>

        <label class="admin-label" data-i18n="other_links_label">Other Links (Web, Portfolio...)</label>
        <div id="linksContainer"></div>
        <button onclick="addLinkField()" id="addLinkBtn" style="background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; color: var(--text-main); cursor: pointer; margin-top:10px; width:100%;">+ Add Custom Link</button>

        <button onclick="saveCard()" id="saveBtn" style="background: var(--accent); border: none; padding: 16px; color: #000; font-weight: bold; border-radius: 12px; margin-top: 20px; cursor: pointer; width: 100%;">SAVE CARD</button>
        <div id="status" style="text-align:center; margin-top:10px; color: yellow; text-shadow: 0 1px 2px black; font-weight:bold;"></div>
    </div>

    <script>
        // --- SLOVNÍK (TRANSLATIONS) ---
        const translations = {
            cs: {
                slug_label: "URL Adresa (Slug)",
                slug_ph: "např. jan-novak",
                theme_label: "Vyber Atmosféru",
                identity_label: "Identita",
                name_ph: "Jméno",
                bio_ph: "Bio / Titul",
                motto_ph: "Motto",
                avatar_label: "Avatar",
                avatar_upload: "NEBO NAHRAJ VLASTNÍ",
                social_label: "Social Hub (Klikni pro přidání)",
                other_links_label: "Jiné Odkazy (Web, Portfolio...)",
                add_link: "+ Vlastní Odkaz",
                save: "ULOŽIT KARTU",
                update: "AKTUALIZOVAT KARTU",
                saving: "Ukládám...",
                done: "HOTOVO!",
                error: "CHYBA",
                social_ph: "uživatelské jméno",
                link_name_ph: "Název (např. Web)",
                link_url_ph: "https://...",
                alert_fill_name: "Vyplň prosím NÁZEV u vlastního odkazu!",
                help_title: "Nápověda",
                help_1: "Mám jen jméno:",
                help_2: "Mám celý odkaz:"
            },
            en: {
                slug_label: "URL Address (Slug)",
                slug_ph: "e.g. john-doe",
                theme_label: "Choose Atmosphere",
                identity_label: "Identity",
                name_ph: "Name",
                bio_ph: "Bio / Job Title",
                motto_ph: "Motto",
                avatar_label: "Avatar",
                avatar_upload: "OR UPLOAD YOUR OWN",
                social_label: "Social Hub (Click to add)",
                other_links_label: "Other Links (Web, Portfolio...)",
                add_link: "+ Add Custom Link",
                save: "SAVE CARD",
                update: "UPDATE CARD",
                saving: "Saving...",
                done: "DONE!",
                error: "ERROR",
                social_ph: "username",
                link_name_ph: "Label (e.g. Website)",
                link_url_ph: "https://...",
                alert_fill_name: "Please enter a LABEL for your custom link!",
                help_title: "Help",
                help_1: "I have username:",
                help_2: "I have full link:"
            }
        };

        let currentLang = 'en';

        function setLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('lang-' + lang).classList.add('active');

            // Texty labelů
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(translations[lang][key]) el.innerText = translations[lang][key];
            });

            // Placeholdery
            const t = translations[lang];
            document.getElementById('slug').placeholder = t.slug_ph;
            document.getElementById('name').placeholder = t.name_ph;
            document.getElementById('bio').placeholder = t.bio_ph;
            document.getElementById('motto').placeholder = t.motto_ph;
            document.getElementById('addLinkBtn').innerText = t.add_link;
            
            // Tlačítko Save (zachovat logiku update/save)
            const slugVal = document.getElementById('slug').value;
            const btn = document.getElementById('saveBtn');
            // Pokud jsme v editačním módu (poznáme podle textu nebo URL), musíme držet kontext,
            // ale pro jednoduchost při přepnutí jazyka resetneme na základní "Save" nebo "Update"
            btn.innerText = t.save; 
            
            // Překlad placeholderů v dynamických polích
            document.querySelectorAll('.social-input').forEach(i => {
                if(!i.closest('.mode-url')) i.placeholder = t.social_ph;
            });
            document.querySelectorAll('.l-lbl').forEach(i => i.placeholder = t.link_name_ph);
            document.querySelectorAll('.l-url').forEach(i => i.placeholder = t.link_url_ph);
        }

        // --- PLATFORMS ---
        const platforms = {
            instagram: { icon: 'fa-instagram', prefix: 'instagram.com/', url: 'https://instagram.com/', label: 'Instagram' },
            facebook:  { icon: 'fa-facebook-f', prefix: 'facebook.com/', url: 'https://facebook.com/', label: 'Facebook' },
            tiktok:    { icon: 'fa-tiktok', prefix: 'tiktok.com/@', url: 'https://tiktok.com/@', label: 'TikTok' },
            youtube:   { icon: 'fa-youtube', prefix: 'youtube.com/@', url: 'https://youtube.com/@', label: 'YouTube' },
            twitter:   { icon: 'fa-x-twitter', prefix: 'x.com/', url: 'https://x.com/', label: 'X' },
            linkedin:  { icon: 'fa-linkedin-in', prefix: 'linkedin.com/in/', url: 'https://linkedin.com/in/', label: 'LinkedIn' },
            twitch:    { icon: 'fa-twitch', prefix: 'twitch.tv/', url: 'https://twitch.tv/', label: 'Twitch' },
            discord:   { icon: 'fa-discord', prefix: 'discord.gg/', url: 'https://discord.gg/', label: 'Discord' },
            pinterest: { icon: 'fa-pinterest', prefix: 'pinterest.com/', url: 'https://pinterest.com/', label: 'Pinterest' },
            reddit:    { icon: 'fa-reddit-alien', prefix: 'reddit.com/user/', url: 'https://reddit.com/user/', label: 'Reddit' },
            snapchat:  { icon: 'fa-snapchat', prefix: 'snapchat.com/add/', url: 'https://snapchat.com/add/', label: 'Snapchat' },
            threads:   { icon: 'fa-brands fa-threads', prefix: 'threads.net/@', url: 'https://threads.net/@', label: 'Threads' }
        };

        // Generování ikon
        const socialGrid = document.getElementById('socialGrid');
        for (const [key, p] of Object.entries(platforms)) {
            const btn = document.createElement('button');
            btn.className = 'social-icon-btn';
            btn.title = p.label;
            btn.onclick = () => addSocial(key);
            btn.innerHTML = `<i class="fa-brands ${p.icon}"></i>`;
            socialGrid.appendChild(btn);
        }

        const activeSocialsDiv = document.getElementById('activeSocialsContainer');

        function addSocial(type, value = "", isFullUrl = false) {
            if(document.querySelector(`.social-input[data-type="${type}"]`)) return;

            const p = platforms[type];
            const div = document.createElement('div');
            div.className = 'active-social-row';
            if(isFullUrl) div.classList.add('mode-url'); 

            div.innerHTML = `
                <i class="fa-brands ${p.icon}" style="font-size:18px; width:25px; text-align:center;"></i>
                <div class="input-wrapper">
                    <span class="social-prefix">${p.prefix}</span>
                    <input class="social-input" type="text" placeholder="${translations[currentLang].social_ph}" data-type="${type}" value="${value}">
                </div>
                <div class="action-group">
                    <div class="mini-btn" title="Help">
                        <i class="fa-solid fa-question"></i>
                        <div class="help-tooltip">
                            <span class="help-title">${p.label}</span>
                            <div class="help-section"><strong style="color:white">1. ${translations[currentLang].help_1}</strong><br>Username only.</div>
                            <div class="help-section"><strong style="color:white">2. ${translations[currentLang].help_2}</strong><br>Click chain icon & paste URL.</div>
                        </div>
                    </div>
                    <button class="mini-btn ${isFullUrl ? 'active' : ''} toggle-mode" onclick="toggleMode(this)"><i class="fa-solid fa-link"></i></button>
                    <button class="mini-btn" onclick="testSocialLink(this, '${type}')"><i class="fa-solid fa-arrow-up-right-from-square"></i></button>
                    <button class="mini-btn remove" onclick="this.closest('.active-social-row').remove()"><i class="fas fa-times"></i></button>
                </div>
            `;
            activeSocialsDiv.appendChild(div);
            
            const input = div.querySelector('.social-input');
            input.addEventListener('input', () => validateRow(div, input.value, type));
            if(value) validateRow(div, value, type);
        }

        function validateRow(row, val, type) {
            val = val.trim();
            row.classList.remove('valid', 'invalid'); 
            if(val.length === 0) return;
            const isUrlMode = row.classList.contains('mode-url');
            if (isUrlMode) {
                const domainCheck = type === 'twitter' ? (val.includes('x.com') || val.includes('twitter.com')) : val.includes(type);
                if (val.startsWith('http') && domainCheck) row.classList.add('valid');
                else row.classList.add('invalid');
            } else {
                if (val.includes(' ') || val.includes('/') || val.includes('.' + type) || val.includes('http')) row.classList.add('invalid');
                else row.classList.add('valid');
            }
        }

        function toggleMode(btn) {
            const row = btn.closest('.active-social-row');
            const input = row.querySelector('.social-input');
            const type = input.getAttribute('data-type');
            row.classList.toggle('mode-url');
            btn.classList.toggle('active');
            if (row.classList.contains('mode-url')) input.placeholder = "https://...";
            else input.placeholder = translations[currentLang].social_ph;
            input.focus();
            validateRow(row, input.value, type);
        }

        function testSocialLink(btn, type) {
            const row = btn.closest('.active-social-row');
            const val = row.querySelector('.social-input').value.trim();
            if(!val) return;
            let finalUrl = row.classList.contains('mode-url') ? val : platforms[type].url + val.replace('@', '');
            if(row.classList.contains('mode-url') && !finalUrl.startsWith('http')) finalUrl = 'https://' + finalUrl;
            window.open(finalUrl, '_blank');
        }

        const linksWrapper = document.getElementById('linksContainer');
        function addLinkField(l="", u="") {
            const d = document.createElement('div'); d.className = 'link-row';
            d.innerHTML = `
                <input class="admin-input l-lbl" placeholder="${translations[currentLang].link_name_ph}" value="${l}" style="width:40%"> 
                <input class="admin-input l-url" placeholder="${translations[currentLang].link_url_ph}" value="${u}" style="width:60%"> 
                <i class="fas fa-times remove-social" style="margin-top:10px;" onclick="this.parentElement.remove()"></i>`;
            linksWrapper.appendChild(d);
        }

        async function saveCard() {
            const stat = document.getElementById('status'); 
            stat.innerText = translations[currentLang].saving;
            
            // VALIDACE VLASTNÍCH ODKAZŮ
            let valid = true;
            document.querySelectorAll('.link-row').forEach(r => {
                const lblInput = r.querySelector('.l-lbl');
                const urlInput = r.querySelector('.l-url');
                
                // Reset stylů
                lblInput.classList.remove('error');
                
                // Pokud je URL vyplněno, ale NÁZEV ne -> CHYBA
                if (urlInput.value.trim() !== "" && lblInput.value.trim() === "") {
                    lblInput.classList.add('error');
                    valid = false;
                }
            });

            if (!valid) {
                alert(translations[currentLang].alert_fill_name);
                stat.innerText = translations[currentLang].error;
                return; // Zastavit ukládání
            }

            const slug = document.getElementById('slug').value.toLowerCase().replace(/\s+/g, '-');
            const links = [];

            // Sbírání Socials
            document.querySelectorAll('.active-social-row').forEach(row => {
                const input = row.querySelector('.social-input');
                const type = input.getAttribute('data-type');
                let val = input.value.trim();
                if(val) {
                    let finalUrl = row.classList.contains('mode-url') ? val : platforms[type].url + val.replace('@', '');
                    if(row.classList.contains('mode-url') && !finalUrl.startsWith('http')) finalUrl = 'https://' + finalUrl;
                    links.push({ label: platforms[type].label, url: finalUrl });
                }
            });

            // Sbírání Custom Links
            document.querySelectorAll('.link-row').forEach(r => {
                const l = r.querySelector('.l-lbl').value; const u = r.querySelector('.l-url').value;
                if(l && u) links.push({label: l, url: u});
            });

            const payload = {
                data: {
                    slug: slug, name: document.getElementById('name').value,
                    bio: document.getElementById('bio').value, motto: document.getElementById('motto').value,
                    theme: document.getElementById('selectedTheme').value,
                    avatar: document.getElementById('base64String').value, links: links
                }
            };

            try {
                await fetch('/api/aeon-api', { method: 'POST', body: JSON.stringify(payload) });
                stat.innerText = translations[currentLang].done; stat.style.color = "#0f0";
                setTimeout(() => window.location.href = `/?slug=${slug}`, 1500);
            } catch(e) { stat.innerText = translations[currentLang].error; }
        }

        // --- INIT ---
        window.onload = async function() {
            // Detekce jazyka
            const userLang = navigator.language || navigator.userLanguage; 
            if (userLang.startsWith('cs') || userLang.startsWith('sk')) setLanguage('cs');
            else setLanguage('en');

            // Avataři & Témata (zůstává z minula, jen render)
            // ... (Zde zkopíruj generování Avatara a Themes z minula, aby to tu nebylo dlouhé. Je to stejné.) ...
            // PRO JISTOTU GENEROVÁNÍ TÉMAT ZNOVU (krátká verze):
            const themes = [
                { id: "spring-morning", name: "Jaro Ráno", bg: "#f3ffe3" }, { id: "spring-noon", name: "Jaro Poledne", bg: "#badc58" },
                { id: "spring-evening", name: "Jaro Večer", bg: "#e056fd", dark:true }, { id: "spring-night", name: "Jaro Noc", bg: "#2c3a47", dark:true },
                { id: "summer-morning", name: "Léto Ráno", bg: "#81ecec" }, { id: "summer-noon", name: "Léto Poledne", bg: "#f9ca24" },
                { id: "summer-evening", name: "Léto Večer", bg: "#eb4d4b", dark:true }, { id: "summer-night", name: "Léto Noc", bg: "#130f40", dark:true },
                { id: "autumn-morning", name: "Podzim Ráno", bg: "#d1ccc0" }, { id: "autumn-noon", name: "Podzim Poledne", bg: "#ffdbcc" },
                { id: "autumn-evening", name: "Podzim Večer", bg: "#e17055", dark:true }, { id: "autumn-night", name: "Podzim Noc", bg: "#2d3436", dark:true },
                { id: "winter-morning", name: "Zima Ráno", bg: "#dfe4ea" }, { id: "winter-noon", name: "Zima Poledne", bg: "#bbdefb" },
                { id: "winter-evening", name: "Zima Večer", bg: "#a29bfe", dark:true }, { id: "winter-night", name: "Zima Noc", bg: "#0c2461", dark:true }
            ];
            const themeContainer = document.getElementById('themeGrid');
            themes.forEach(t => {
                const div = document.createElement('div');
                div.className = 'theme-btn' + (t.dark ? ' dark-text' : '');
                div.innerText = t.name; div.style.background = t.bg;
                div.onclick = () => {
                    document.getElementById('selectedTheme').value = t.id;
                    document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('selected'));
                    div.classList.add('selected');
                    document.body.className = ''; const parts = t.id.split('-'); document.body.classList.add(parts[0]); document.body.classList.add(parts[1]);
                };
                themeContainer.appendChild(div);
            });
            // Avatars
            const seeds = ["Leo", "Mila", "Caleb", "Eliza", "Chase", "Jade", "Nora", "Jack", "Felix", "Ruby"];
            const avContainer = document.getElementById('avatarStudio');
            seeds.forEach(s => {
                const img = document.createElement('img');
                const url = `https://api.dicebear.com/7.x/notionists/svg?seed=${s}&backgroundColor=transparent`;
                img.src = url; img.className = 'avatar-option';
                img.onclick = () => {
                    document.getElementById('base64String').value = url; document.getElementById('preview').src = url;
                    document.querySelectorAll('.avatar-option').forEach(x => x.classList.remove('selected')); img.classList.add('selected');
                };
                avContainer.appendChild(img);
            });

            // LOAD DATA
            const params = new URLSearchParams(window.location.search);
            const slug = params.get('slug');
            if(slug) {
                document.getElementById('slug').value = slug;
                document.getElementById('saveBtn').innerText = translations[currentLang].update;
                try {
                    const res = await fetch(`/api/aeon-api?slug=${slug}`);
                    if(res.ok) {
                        const d = await res.json();
                        document.getElementById('name').value = d.name || "";
                        document.getElementById('bio').value = d.bio || "";
                        document.getElementById('motto').value = d.motto || "";
                        if(d.theme) {
                            const btn = Array.from(document.querySelectorAll('.theme-btn')).find(b => b.innerText.includes(d.theme.split('-')[1].charAt(0).toUpperCase())); 
                            if(btn) btn.click();
                        } else { selectTheme('winter-night', document.createElement('div')); }
                        if(d.avatar) { document.getElementById('base64String').value = d.avatar; document.getElementById('preview').src = d.avatar; }
                        
                        activeSocialsDiv.innerHTML = '';
                        linksWrapper.innerHTML = '';
                        
                        if(d.links) {
                            d.links.forEach(x => {
                                let found = false;
                                for (const [key, p] of Object.entries(platforms)) {
                                    if (x.url.startsWith(p.url)) {
                                        addSocial(key, x.url.replace(p.url, ''), false); found = true; break;
                                    } else if (x.url.includes(key) || (key==='twitter' && x.url.includes('x.com'))) {
                                        addSocial(key, x.url, true); found = true; break;
                                    }
                                }
                                if (!found) addLinkField(x.label, x.url);
                            });
                        }
                    }
                } catch(e){}
            } else { 
                // Default theme selection visual
                 // (Simplified for brevity)
            }
            document.getElementById('loading').style.display = 'none';
        }

        document.getElementById('photoInput').addEventListener('change', function(e) {
            const file = e.target.files[0]; if(!file) return;
            const r = new FileReader();
            r.onload = function(ev) {
                const i = new Image(); i.onload = function() {
                    const c = document.createElement('canvas'); const x = c.getContext('2d');
                    const m = 500; let w=i.width, h=i.height;
                    if(w>h){if(w>m){h*=m/w;w=m}}else{if(h>m){w*=m/h;h=m}}
                    c.width=w; c.height=h; x.drawImage(i,0,0,w,h);
                    const d = c.toDataURL('image/jpeg',0.8);
                    document.getElementById('preview').src=d; document.getElementById('base64String').value=d;
                }; i.src = ev.target.result;
            }; r.readAsDataURL(file);
        });
    </script>
</body>
</html>