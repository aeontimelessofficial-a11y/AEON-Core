<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÆON | Studio</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Specifické pro admin, aby se dalo scrollovat */
        body { overflow-y: auto; display: block; }
    </style>
</head>
<body>

    <div class="fixed-background">
        <div class="orb orb-1"></div><div class="orb orb-2"></div>
        <div class="orb orb-3"></div><div class="orb orb-4"></div>
    </div>

    <div class="admin-container">
        <h1 style="color: var(--text-main); text-align: center;">ÆON Studio</h1>
        <div id="loading" style="text-align:center; color:var(--accent); font-size: 12px;">NAČÍTÁM DATA...</div>

        <label class="admin-label">URL (Slug)</label>
        <input type="text" class="admin-input" id="slug" placeholder="např. ondra" required>

        <label class="admin-label">Vyber Atmosféru (Klikni pro živý náhled)</label>
        <div class="theme-grid" id="themeGrid"></div>
        <input type="hidden" id="selectedTheme" value="winter-night">

        <label class="admin-label">Jméno</label>
        <input type="text" class="admin-input" id="name" placeholder="Jan Novák">
        
        <label class="admin-label">Bio</label>
        <input type="text" class="admin-input" id="bio" placeholder="Digital Creator">
        
        <label class="admin-label">Motto (Pod Bio)</label>
        <input type="text" class="admin-input" id="motto" placeholder="Např. FUTURE IS NOW">

        <label class="admin-label">Avatar</label>
        <div class="avatar-grid" id="avatarStudio"></div>
        <div style="text-align:center; font-size:10px; color:var(--text-main); opacity:0.7; margin: 5px 0;">NEBO NAHRAJ VLASTNÍ</div>
        <input type="file" id="photoInput" accept="image/*" style="color: var(--text-main);">
        <input type="hidden" id="base64String">
        <img id="preview" style="width:50px; height:50px; border-radius:50%; margin: 10px auto; display:block; object-fit:cover; border: 2px solid var(--accent);">

        <label class="admin-label">Odkazy</label>
        <div id="linksContainer"></div>
        <button onclick="addLinkField()" style="background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; color: var(--text-main); cursor: pointer; margin-top:10px; width:100%;">+ Přidat Odkaz</button>

        <button onclick="saveCard()" id="saveBtn" style="background: var(--accent); border: none; padding: 16px; color: #000; font-weight: bold; border-radius: 12px; margin-top: 20px; cursor: pointer; width: 100%;">ULOŽIT KARTU</button>
        <div id="status" style="text-align:center; margin-top:10px; color: yellow; text-shadow: 0 1px 2px black; font-weight:bold;"></div>
    </div>

    <script>
        // Témata (flag 'dark' pro barvu textu v tlačítku)
        const themes = [
            { id: "spring-morning", name: "Jaro Ráno", bg: "#f3ffe3" }, { id: "spring-noon", name: "Jaro Poledne", bg: "#badc58" },
            { id: "spring-evening", name: "Jaro Večer", bg: "#e056fd", dark:true }, { id: "spring-night", name: "Jaro Noc", bg: "#2c3a47", dark:true },
            { id: "summer-morning", name: "Léto Ráno", bg: "#81ecec" }, { id: "summer-noon", name: "Léto Poledne", bg: "#f9ca24" },
            { id: "summer-evening", name: "Léto Večer", bg: "#eb4d4b", dark:true }, { id: "summer-night", name: "Léto Noc", bg: "#130f40", dark:true },
            { id: "autumn-morning", name: "Podzim Ráno", bg: "#d1ccc0" }, { id: "autumn-noon", name: "Podzim Poledne", bg: "#ffdbcc" },
            { id: "autumn-evening", name: "Podzim Večer", bg: "#e17055", dark:true }, { id: "autumn-night", name: "Podzim Noc", bg: "#2d3436", dark:true },
            { id: "winter-morning", name: "Zima Ráno", bg: "#dfe4ea" }, { id: "winter-noon", name: "Zima Poledne", bg: "#bbdefb" },
            { id: "winter-evening", name: "Zima Večer", bg: "#a29bfe", dark:true }, { id: "winter-night", name: "Zima Noc", bg: "#0c2461", dark:true }
        ];

        const themeContainer = document.getElementById('themeGrid');
        themes.forEach(t => {
            const div = document.createElement('div');
            div.className = 'theme-btn' + (t.dark ? ' dark-text' : '');
            div.innerText = t.name;
            div.style.background = t.bg;
            div.onclick = () => selectTheme(t.id, div);
            themeContainer.appendChild(div);
        });

        // ŽIVÝ NÁHLED
        function selectTheme(id, el) {
            document.getElementById('selectedTheme').value = id;
            document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            
            document.body.className = ''; 
            const parts = id.split('-');
            document.body.classList.add(parts[0]); document.body.classList.add(parts[1]);
        }

        // Avataři
        const seeds = ["Leo", "Mila", "Caleb", "Eliza", "Chase", "Jade", "Nora", "Jack", "Felix", "Ruby"];
        const avContainer = document.getElementById('avatarStudio');
        seeds.forEach(s => {
            const img = document.createElement('img');
            const url = `https://api.dicebear.com/7.x/notionists/svg?seed=${s}&backgroundColor=transparent`;
            img.src = url; img.className = 'avatar-option';
            img.onclick = () => {
                document.getElementById('base64String').value = url;
                document.getElementById('preview').src = url;
                document.querySelectorAll('.avatar-option').forEach(x => x.classList.remove('selected'));
                img.classList.add('selected');
            };
            avContainer.appendChild(img);
        });

        const linksWrapper = document.getElementById('linksContainer');
        function addLinkField(l="", u="") {
            const d = document.createElement('div'); d.className = 'link-row';
            d.innerHTML = `<input class="admin-input l-lbl" placeholder="Název" value="${l}" style="width:40%"> <input class="admin-input l-url" placeholder="URL" value="${u}" style="width:60%">`;
            linksWrapper.appendChild(d);
        }

        window.onload = async function() {
            const params = new URLSearchParams(window.location.search);
            const slug = params.get('slug');
            if(slug) {
                document.getElementById('slug').value = slug;
                document.getElementById('saveBtn').innerText = "AKTUALIZOVAT";
                try {
                    const res = await fetch(`/.netlify/functions/aeon-api?slug=${slug}`);
                    if(res.ok) {
                        const d = await res.json();
                        document.getElementById('name').value = d.name || "";
                        document.getElementById('bio').value = d.bio || "";
                        document.getElementById('motto').value = d.motto || "";
                        
                        if(d.theme) {
                            const btn = Array.from(document.querySelectorAll('.theme-btn')).find(b => b.innerText.includes(d.theme.split('-')[1].charAt(0).toUpperCase())); 
                            selectTheme(d.theme, btn || document.createElement('div'));
                        } else { selectTheme('winter-night', document.createElement('div')); }

                        if(d.avatar) { document.getElementById('base64String').value = d.avatar; document.getElementById('preview').src = d.avatar; }
                        linksWrapper.innerHTML = '';
                        if(d.links) d.links.forEach(x => addLinkField(x.label, x.url));
                        if(!d.links || d.links.length === 0) { addLinkField(); addLinkField(); }
                    }
                } catch(e){}
            } else { addLinkField(); addLinkField(); selectTheme('winter-night', document.createElement('div')); }
            document.getElementById('loading').style.display = 'none';
        }

        async function saveCard() {
            const stat = document.getElementById('status'); stat.innerText = "Ukládám...";
            const slug = document.getElementById('slug').value.toLowerCase().replace(/\s+/g, '-');
            const links = [];
            document.querySelectorAll('.link-row').forEach(r => {
                const l = r.querySelector('.l-lbl').value; const u = r.querySelector('.l-url').value;
                if(l && u) links.push({label: l, url: u});
            });

            const payload = {
                data: {
                    slug: slug, name: document.getElementById('name').value,
                    bio: document.getElementById('bio').value, motto: document.getElementById('motto').value,
                    theme: document.getElementById('selectedTheme').value,
                    avatar: document.getElementById('base64String').value, links: links
                }
            };

            try {
                await fetch('/.netlify/functions/aeon-api', { method: 'POST', body: JSON.stringify(payload) });
                stat.innerText = "HOTOVO!"; stat.style.color = "#0f0";
                setTimeout(() => window.location.href = `/?slug=${slug}`, 1500);
            } catch(e) { stat.innerText = "CHYBA"; }
        }

        document.getElementById('photoInput').addEventListener('change', function(e) {
            const file = e.target.files[0]; if(!file) return;
            const r = new FileReader();
            r.onload = function(ev) {
                const i = new Image(); i.onload = function() {
                    const c = document.createElement('canvas'); const x = c.getContext('2d');
                    const m = 500; let w=i.width, h=i.height;
                    if(w>h){if(w>m){h*=m/w;w=m}}else{if(h>m){w*=m/h;h=m}}
                    c.width=w; c.height=h; x.drawImage(i,0,0,w,h);
                    const d = c.toDataURL('image/jpeg',0.8);
                    document.getElementById('preview').src=d; document.getElementById('base64String').value=d;
                }; i.src = ev.target.result;
            }; r.readAsDataURL(file);
        });
    </script>
</body>
</html>