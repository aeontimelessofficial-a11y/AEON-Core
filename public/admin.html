<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÆON | Studio</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Admin specifika */
        body { 
            overflow-y: auto; height: auto; min-height: 100vh; padding: 40px 0; display: block; 
            /* Pozadí bude ovládáno přes JS stejně jako karta */
        }
        .admin-container { 
            width: 90%; max-width: 550px; margin: 0 auto; 
            background: #111; border: 1px solid #333; /* Pevné tmavé pozadí pro formulář */
        }
        
        .admin-label { color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; margin-top: 15px; display: block; font-weight: 700; }
        .admin-input { 
            background: #222; border: 1px solid #333; color: white; padding: 16px; border-radius: 12px; width: 100%; box-sizing: border-box; 
            font-family: inherit; font-size: 14px; outline: none;
        }
        .admin-input:focus { border-color: white; }
        
        /* THEME GRID - Všechna témata */
        .theme-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-height: 300px; overflow-y: auto; padding: 5px; background: #222; border-radius: 12px; }
        .theme-btn {
            padding: 12px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; text-align: center;
            font-size: 11px; font-weight: bold; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
        .theme-btn:hover { transform: scale(1.02); }
        .theme-btn.selected { border-color: #fff; box-shadow: 0 0 10px rgba(255,255,255,0.5); }

        /* Avatars */
        .avatar-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; background: #222; padding: 15px; border-radius: 12px; }
        .avatar-option { width: 100%; border-radius: 50%; cursor: pointer; transition: 0.2s; border: 2px solid transparent; background: #fff; }
        .avatar-option:hover { transform: scale(1.1); }
        .avatar-option.selected { border-color: #fff; box-shadow: 0 0 10px #fff; }

        .link-row { display: flex; gap: 10px; margin-bottom: 8px; }
        
        button#saveBtn {
            background: white; border: none; padding: 18px; color: black; font-weight: bold;
            border-radius: 12px; margin-top: 20px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; width: 100%;
        }
    </style>
</head>
<body>

    <div class="ambient-background">
        <div class="orb orb-1"></div><div class="orb orb-2"></div><div class="orb orb-3"></div><div class="orb orb-4"></div>
    </div>

    <div class="admin-container">
        <h1 style="color: white; text-align: center; margin-bottom: 20px;">ÆON Studio</h1>
        <div id="loading" style="text-align:center; color:#888; font-size: 12px;">NAČÍTÁM...</div>

        <label class="admin-label">URL (Slug)</label>
        <input type="text" class="admin-input" id="slug" placeholder="např. ondra" required>

        <label class="admin-label">Tapeta (Okamžitý Náhled)</label>
        <div class="theme-grid" id="themeGrid"></div>
        <input type="hidden" id="selectedTheme" value="winter-night">

        <label class="admin-label">Jméno</label>
        <input type="text" class="admin-input" id="name" placeholder="Jan Novák">
        <label class="admin-label">Bio</label>
        <input type="text" class="admin-input" id="bio" placeholder="Digital Creator">
        <label class="admin-label">Motto (Pozadí)</label>
        <input type="text" class="admin-input" id="motto" placeholder="FUTURE IS NOW">

        <label class="admin-label">Avatar</label>
        <div class="avatar-grid" id="avatarStudio"></div>
        <input type="file" id="photoInput" accept="image/*" style="margin-top:10px; color:#888;">
        <input type="hidden" id="base64String">
        <img id="preview" style="width:50px; height:50px; border-radius:50%; margin: 10px auto; display:block; object-fit:cover; border: 1px solid #333;">

        <label class="admin-label">Odkazy</label>
        <div id="linksContainer"></div>
        <button onclick="addLinkField()" style="background:#333; color:#fff; border:1px solid #444; padding:10px; border-radius:8px; margin-top:10px; width:100%; cursor:pointer;">+ Přidat</button>

        <button onclick="saveCard()" id="saveBtn">ULOŽIT KARTU</button>
        <div id="status" style="text-align:center; margin-top:10px; color: yellow;"></div>
    </div>

    <script>
        // 1. THEMES LIST
        const themes = [
            { id: "spring-morning", name: "Jaro - Ráno", bg: "linear-gradient(45deg, #f3ffe3, #fff0f5)", dark: true },
            { id: "spring-noon", name: "Jaro - Poledne", bg: "linear-gradient(45deg, #badc58, #dff9fb)", dark: true },
            { id: "spring-evening", name: "Jaro - Večer", bg: "linear-gradient(45deg, #e056fd, #f0932b)", dark: true },
            { id: "spring-night", name: "Jaro - Noc", bg: "linear-gradient(45deg, #2c3a47, #58b19f)" },
            
            { id: "summer-morning", name: "Léto - Ráno", bg: "linear-gradient(45deg, #fff3e0, #81ecec)", dark: true },
            { id: "summer-noon", name: "Léto - Poledne", bg: "linear-gradient(45deg, #f9ca24, #f0932b)", dark: true },
            { id: "summer-evening", name: "Léto - Večer", bg: "linear-gradient(45deg, #eb4d4b, #686de0)", dark: true },
            { id: "summer-night", name: "Léto - Noc", bg: "linear-gradient(45deg, #130f40, #30336b)" },

            { id: "autumn-morning", name: "Podzim - Ráno", bg: "linear-gradient(45deg, #f7f1e3, #d1ccc0)", dark: true },
            { id: "autumn-noon", name: "Podzim - Poledne", bg: "linear-gradient(45deg, #fff5e6, #ffdbcc)", dark: true },
            { id: "autumn-evening", name: "Podzim - Večer", bg: "linear-gradient(45deg, #ffda79, #ffb142)", dark: true },
            { id: "autumn-night", name: "Podzim - Noc", bg: "linear-gradient(45deg, #2d3436, #0f0c29)" },

            { id: "winter-morning", name: "Zima - Ráno", bg: "linear-gradient(45deg, #f1f2f6, #dfe4ea)", dark: true },
            { id: "winter-noon", name: "Zima - Poledne", bg: "linear-gradient(45deg, #e3f2fd, #bbdefb)", dark: true },
            { id: "winter-evening", name: "Zima - Večer", bg: "linear-gradient(45deg, #6c5ce7, #a29bfe)", dark: true },
            { id: "winter-night", name: "Zima - Noc", bg: "linear-gradient(45deg, #0c2461, #1e3799)" }
        ];

        const themeContainer = document.getElementById('themeGrid');
        themes.forEach(t => {
            const div = document.createElement('div');
            div.className = 'theme-btn';
            div.innerText = t.name;
            div.style.background = t.bg;
            div.style.color = t.dark ? '#000' : '#fff';
            div.onclick = () => selectTheme(t.id, div);
            themeContainer.appendChild(div);
        });

        // LIVE PREVIEW FUNCTION
        function selectTheme(id, el) {
            document.getElementById('selectedTheme').value = id;
            document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            
            // Okamžitá aplikace na body editoru
            document.body.className = '';
            const parts = id.split('-');
            document.body.classList.add(parts[0]);
            document.body.classList.add(parts[1]);
        }

        // 2. AVATARS
        const seeds = ["Leo", "Mila", "Caleb", "Eliza", "Chase", "Jade", "Nora", "Jack", "Felix", "Ruby"];
        const avContainer = document.getElementById('avatarStudio');
        seeds.forEach(s => {
            const img = document.createElement('img');
            const url = `https://api.dicebear.com/7.x/notionists/svg?seed=${s}&backgroundColor=transparent`;
            img.src = url; img.className = 'avatar-option';
            img.onclick = () => {
                document.getElementById('base64String').value = url;
                document.getElementById('preview').src = url;
                document.querySelectorAll('.avatar-option').forEach(x => x.classList.remove('selected'));
                img.classList.add('selected');
            };
            avContainer.appendChild(img);
        });

        // 3. LOAD
        const linksWrapper = document.getElementById('linksContainer');
        function addLinkField(l="", u="") {
            const d = document.createElement('div'); d.className = 'link-row';
            d.innerHTML = `<input class="admin-input l-lbl" placeholder="Název" value="${l}" style="width:40%"> <input class="admin-input l-url" placeholder="URL" value="${u}" style="width:60%">`;
            linksWrapper.appendChild(d);
        }

        window.onload = async function() {
            const params = new URLSearchParams(window.location.search);
            const slug = params.get('slug');
            if(slug) {
                document.getElementById('slug').value = slug;
                document.getElementById('saveBtn').innerText = "AKTUALIZOVAT";
                try {
                    const res = await fetch(`/.netlify/functions/aeon-api?slug=${slug}`);
                    if(res.ok) {
                        const d = await res.json();
                        document.getElementById('name').value = d.name || "";
                        document.getElementById('bio').value = d.bio || "";
                        document.getElementById('motto').value = d.motto || "";
                        
                        if(d.theme) {
                            // Najít tlačítko a simulovat klik
                            const btn = Array.from(document.querySelectorAll('.theme-btn')).find(b => b.innerText.includes(d.theme.replace('winter-night', 'Zima - Noc'))); // Zjednodušeno
                            // Lepší: najít v datech
                            const tIndex = themes.findIndex(x => x.id === d.theme);
                            if(tIndex > -1) selectTheme(d.theme, document.querySelectorAll('.theme-btn')[tIndex]);
                            else selectTheme('winter-night', document.querySelectorAll('.theme-btn')[15]);
                        } else {
                            selectTheme('winter-night', document.querySelectorAll('.theme-btn')[15]);
                        }

                        if(d.avatar) {
                            document.getElementById('base64String').value = d.avatar;
                            document.getElementById('preview').src = d.avatar;
                        }
                        linksWrapper.innerHTML = '';
                        if(d.links) d.links.forEach(x => addLinkField(x.label, x.url));
                        if(!d.links || d.links.length === 0) { addLinkField(); addLinkField(); }
                    }
                } catch(e){}
            } else { 
                addLinkField(); addLinkField(); 
                selectTheme('winter-night', document.querySelectorAll('.theme-btn')[15]);
            }
            document.getElementById('loading').style.display = 'none';
        }

        // 4. SAVE
        async function saveCard() {
            const stat = document.getElementById('status'); stat.innerText = "Ukládám...";
            const slug = document.getElementById('slug').value.toLowerCase().replace(/\s+/g, '-');
            const links = [];
            document.querySelectorAll('.link-row').forEach(r => {
                const l = r.querySelector('.l-lbl').value; const u = r.querySelector('.l-url').value;
                if(l && u) links.push({label: l, url: u});
            });

            const payload = {
                data: {
                    slug: slug,
                    name: document.getElementById('name').value,
                    bio: document.getElementById('bio').value,
                    motto: document.getElementById('motto').value,
                    theme: document.getElementById('selectedTheme').value,
                    avatar: document.getElementById('base64String').value,
                    links: links
                }
            };

            try {
                await fetch('/.netlify/functions/aeon-api', { method: 'POST', body: JSON.stringify(payload) });
                stat.innerText = "HOTOVO!"; stat.style.color = "#0f0";
                setTimeout(() => window.location.href = `/?slug=${slug}`, 1500);
            } catch(e) { stat.innerText = "CHYBA"; }
        }

        document.getElementById('photoInput').addEventListener('change', function(e) {
            const file = e.target.files[0]; if(!file) return;
            const r = new FileReader();
            r.onload = function(ev) {
                const i = new Image(); i.onload = function() {
                    const c = document.createElement('canvas'); const x = c.getContext('2d');
                    const m = 500; let w=i.width, h=i.height;
                    if(w>h){if(w>m){h*=m/w;w=m}}else{if(h>m){w*=m/h;h=m}}
                    c.width=w; c.height=h; x.drawImage(i,0,0,w,h);
                    const d = c.toDataURL('image/jpeg',0.8);
                    document.getElementById('preview').src=d; document.getElementById('base64String').value=d;
                }; i.src = ev.target.result;
            }; r.readAsDataURL(file);
        });
    </script>
</body>
</html>