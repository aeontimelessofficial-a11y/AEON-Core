<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√ÜON | Studio</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Z√ÅKLADN√ç ROZLO≈ΩEN√ç */
        body { overflow-y: auto; display: block; padding-bottom: 50px; }
        
        .social-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;
        }
        
        .social-icon-btn {
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 12px; height: 50px; cursor: pointer; 
            color: var(--text-main);
            font-size: 20px; display: flex; justify-content: center; align-items: center;
            transition: 0.2s; position: relative;
        }
        .social-icon-btn:hover { 
            background: var(--accent); color: #000; border-color: transparent; transform: translateY(-2px);
        }
        
        /* AKTIVN√ç ≈ò√ÅDEK */
        .active-social-row {
            display: flex; align-items: center; gap: 8px; 
            background: var(--input-bg);
            padding: 8px 12px; border-radius: 10px; margin-bottom: 8px; 
            border: 1px solid var(--border);
            color: var(--text-main);
            animation: fadeIn 0.3s ease; position: relative;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        /* STAVY VALIDACE */
        /* Spr√°vnƒõ (Zelen√°) */
        .active-social-row.valid { 
            border-color: #00ff88; 
            box-shadow: 0 0 5px rgba(0, 255, 136, 0.2);
        }
        /* Chyba (ƒåerven√°) */
        .active-social-row.invalid { 
            border-color: #ff4757; 
            box-shadow: 0 0 5px rgba(255, 71, 87, 0.2);
        }

        .input-wrapper { flex-grow: 1; display: flex; align-items: center; overflow: hidden; }
        
        .social-prefix {
            font-size: 11px; color: var(--text-main); opacity: 0.6;
            white-space: nowrap; font-family: monospace; 
            margin-right: 4px; transition: 0.3s;
        }
        .active-social-row.mode-url .social-prefix { display: none; }
        
        .social-input {
            background: transparent; border: none; color: var(--text-main);
            width: 100%; outline: none; font-weight: bold; font-size: 14px;
        }
        .social-input::placeholder { color: var(--text-main); opacity: 0.3; }

        .action-group { display: flex; gap: 4px; }
        
        .mini-btn {
            width: 28px; height: 28px; border-radius: 6px; border: none;
            background: rgba(128, 128, 128, 0.2); color: var(--text-main); opacity: 0.7;
            cursor: pointer; display: flex; align-items: center; justify-content: center; 
            font-size: 12px; transition: 0.2s; position: relative;
        }
        .mini-btn:hover { background: var(--accent); color: #000; opacity: 1; }
        .mini-btn.active { color: var(--accent); background: rgba(0,0,0,0.5); border: 1px solid var(--accent); opacity: 1; }
        .mini-btn.remove:hover { background: #ff4757; color: white; }

        /* TOOLTIP */
        .help-tooltip {
            position: absolute; bottom: 35px; right: 0; width: 280px;
            background: #111; border: 1px solid rgba(255,255,255,0.2); color: #ddd;
            padding: 12px; border-radius: 8px; z-index: 100;
            display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            font-size: 11px; line-height: 1.4; 
        }
        .mini-btn:hover .help-tooltip { display: block; }
        .help-title { color: var(--accent); font-weight: bold; margin-bottom: 4px; display: block; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .help-section { margin-bottom: 8px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="fixed-background">
        <div class="orb orb-1"></div><div class="orb orb-2"></div>
        <div class="orb orb-3"></div><div class="orb orb-4"></div>
    </div>

    <div class="admin-container">
        <h1 style="color: var(--text-main); text-align: center;">√ÜON Studio</h1>
        <div id="loading" style="text-align:center; color:var(--accent); font-size: 12px;">NAƒå√çT√ÅM DATA...</div>

        <label class="admin-label">URL (Slug)</label>
        <input type="text" class="admin-input" id="slug" placeholder="nap≈ô. ondra" required>

        <label class="admin-label">Vyber Atmosf√©ru</label>
        <div class="theme-grid" id="themeGrid"></div>
        <input type="hidden" id="selectedTheme" value="winter-night">

        <label class="admin-label">Identita</label>
        <input type="text" class="admin-input" id="name" placeholder="Jm√©no">
        <input type="text" class="admin-input" id="bio" placeholder="Bio / Titul" style="margin-top:5px;">
        <input type="text" class="admin-input" id="motto" placeholder="Motto" style="margin-top:5px;">

        <label class="admin-label">Avatar</label>
        <div class="avatar-grid" id="avatarStudio"></div>
        <div style="text-align:center; font-size:10px; color:var(--text-main); opacity:0.7; margin: 5px 0;">NEBO NAHRAJ VLASTN√ç</div>
        <input type="file" id="photoInput" accept="image/*" style="color: var(--text-main);">
        <input type="hidden" id="base64String">
        <img id="preview" style="width:50px; height:50px; border-radius:50%; margin: 10px auto; display:block; object-fit:cover; border: 2px solid var(--accent);">

        <label class="admin-label">Social Hub (Klikni ikonu a zadej ID)</label>
        <div class="social-grid">
            <button class="social-icon-btn" onclick="addSocial('instagram')" title="Instagram"><i class="fab fa-instagram"></i></button>
            <button class="social-icon-btn" onclick="addSocial('facebook')" title="Facebook"><i class="fab fa-facebook-f"></i></button>
            <button class="social-icon-btn" onclick="addSocial('tiktok')" title="TikTok"><i class="fab fa-tiktok"></i></button>
            <button class="social-icon-btn" onclick="addSocial('youtube')" title="YouTube"><i class="fab fa-youtube"></i></button>
            <button class="social-icon-btn" onclick="addSocial('twitter')" title="X (Twitter)"><i class="fa-brands fa-x-twitter"></i></button>
            <button class="social-icon-btn" onclick="addSocial('linkedin')" title="LinkedIn"><i class="fab fa-linkedin-in"></i></button>
            <button class="social-icon-btn" onclick="addSocial('twitch')" title="Twitch"><i class="fab fa-twitch"></i></button>
            <button class="social-icon-btn" onclick="addSocial('discord')" title="Discord"><i class="fab fa-discord"></i></button>
            <button class="social-icon-btn" onclick="addSocial('pinterest')" title="Pinterest"><i class="fab fa-pinterest"></i></button>
            <button class="social-icon-btn" onclick="addSocial('reddit')" title="Reddit"><i class="fab fa-reddit-alien"></i></button>
            <button class="social-icon-btn" onclick="addSocial('snapchat')" title="Snapchat"><i class="fab fa-snapchat"></i></button>
            <button class="social-icon-btn" onclick="addSocial('threads')" title="Threads"><i class="fa-brands fa-threads"></i></button>
        </div>

        <div id="activeSocialsContainer"></div>

        <label class="admin-label">Jin√© Odkazy (Web, Portfolio...)</label>
        <div id="linksContainer"></div>
        <button onclick="addLinkField()" style="background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; color: var(--text-main); cursor: pointer; margin-top:10px; width:100%;">+ Vlastn√≠ odkaz</button>

        <button onclick="saveCard()" id="saveBtn" style="background: var(--accent); border: none; padding: 16px; color: #000; font-weight: bold; border-radius: 12px; margin-top: 20px; cursor: pointer; width: 100%;">ULO≈ΩIT KARTU</button>
        <div id="status" style="text-align:center; margin-top:10px; color: yellow; text-shadow: 0 1px 2px black; font-weight:bold;"></div>
    </div>

    <script>
        const platforms = {
            instagram: { icon: 'fa-instagram', prefix: 'instagram.com/', url: 'https://instagram.com/', label: 'Instagram', tip: 'Jm√©no je naho≈ôe na profilu.' },
            facebook:  { icon: 'fa-facebook-f', prefix: 'facebook.com/', url: 'https://facebook.com/', label: 'Facebook', tip: 'Jdi na sv≈Øj profil > ... > Kop√≠rovat odkaz.' },
            tiktok:    { icon: 'fa-tiktok', prefix: 'tiktok.com/@', url: 'https://tiktok.com/@', label: 'TikTok', tip: 'Je to jm√©no pod fotkou zaƒç√≠naj√≠c√≠ @.' },
            youtube:   { icon: 'fa-youtube', prefix: 'youtube.com/@', url: 'https://youtube.com/@', label: 'YouTube', tip: 'Pou≈æij "handle" (nap≈ô. @mujkanal).' },
            twitter:   { icon: 'fa-x-twitter', prefix: 'x.com/', url: 'https://x.com/', label: 'X', tip: 'Tv√© @jm√©no bez zavin√°ƒçe.' },
            linkedin:  { icon: 'fa-linkedin-in', prefix: 'linkedin.com/in/', url: 'https://linkedin.com/in/', label: 'LinkedIn', tip: 'Upravit ve≈ôejn√Ω profil a URL.' },
            twitch:    { icon: 'fa-twitch', prefix: 'twitch.tv/', url: 'https://twitch.tv/', label: 'Twitch', tip: 'Tv√© jm√©no kan√°lu.' },
            discord:   { icon: 'fa-discord', prefix: 'discord.gg/', url: 'https://discord.gg/', label: 'Discord', tip: 'Vlo≈æ "Invite Link" na server.' },
            pinterest: { icon: 'fa-pinterest', prefix: 'pinterest.com/', url: 'https://pinterest.com/', label: 'Pinterest', tip: 'Jm√©no v URL adrese profilu.' },
            reddit:    { icon: 'fa-reddit-alien', prefix: 'reddit.com/user/', url: 'https://reddit.com/user/', label: 'Reddit', tip: 'Tv√© u/username.' },
            snapchat:  { icon: 'fa-snapchat', prefix: 'snapchat.com/add/', url: 'https://snapchat.com/add/', label: 'Snapchat', tip: 'Nastaven√≠ > U≈æivatelsk√© jm√©no.' },
            threads:   { icon: 'fa-threads', prefix: 'threads.net/@', url: 'https://threads.net/@', label: 'Threads', tip: 'Stejn√© jako na Instagramu.' }
        };

        const activeSocialsDiv = document.getElementById('activeSocialsContainer');

        function addSocial(type, value = "", isFullUrl = false) {
            if(document.querySelector(`.social-input[data-type="${type}"]`)) return;

            const p = platforms[type];
            const div = document.createElement('div');
            div.className = 'active-social-row';
            if(isFullUrl) div.classList.add('mode-url'); 

            div.innerHTML = `
                <i class="fa-brands ${p.icon}" style="font-size:18px; width:25px; text-align:center;"></i>
                
                <div class="input-wrapper">
                    <span class="social-prefix">${p.prefix}</span>
                    <input class="social-input" type="text" placeholder="username" data-type="${type}" value="${value}">
                </div>

                <div class="action-group">
                    <div class="mini-btn" title="N√°povƒõda">
                        <i class="fa-solid fa-question"></i>
                        <div class="help-tooltip">
                            <span class="help-title">${p.label} - N√°povƒõda</span>
                            <div class="help-section"><strong style="color:white">1. M√°m jen p≈ôezd√≠vku:</strong><br>Zadej ji do pol√≠ƒçka. ${p.tip}</div>
                            <div class="help-section"><strong style="color:white">2. M√°m cel√Ω odkaz:</strong><br>Klikni na ikonu ≈ôetƒõzu (üîó) a vlo≈æ celou adresu.</div>
                        </div>
                    </div>
                    <button class="mini-btn ${isFullUrl ? 'active' : ''} toggle-mode" title="P≈ôepnout: Cel√Ω odkaz / Jen jm√©no" onclick="toggleMode(this)">
                        <i class="fa-solid fa-link"></i>
                    </button>
                    <button class="mini-btn" title="Otestovat" onclick="testSocialLink(this, '${type}')">
                        <i class="fa-solid fa-arrow-up-right-from-square"></i>
                    </button>
                    <button class="mini-btn remove" title="Odstranit" onclick="this.closest('.active-social-row').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            activeSocialsDiv.appendChild(div);
            
            const input = div.querySelector('.social-input');
            input.addEventListener('input', () => validateRow(div, input.value, type));
            if(value) validateRow(div, value, type);
        }

        // --- VALIDACE (SEMAFOR) ---
        function validateRow(row, val, type) {
            val = val.trim();
            row.classList.remove('valid', 'invalid'); // Reset

            if(val.length === 0) return; // Pr√°zdn√© = neutr√°ln√≠

            const isUrlMode = row.classList.contains('mode-url');

            // 1. Validace pro re≈æim CEL√Å URL
            if (isUrlMode) {
                // Mus√≠ zaƒç√≠nat http a obsahovat n√°zev platformy (nap≈ô. "instagram")
                // (V√Ωjimka pro "x.com" a "twitter")
                const domainCheck = type === 'twitter' ? (val.includes('x.com') || val.includes('twitter.com')) : val.includes(type);
                
                if (val.startsWith('http') && domainCheck) {
                    row.classList.add('valid');
                } else {
                    row.classList.add('invalid');
                }
            } 
            // 2. Validace pro re≈æim USERNAME
            else {
                // Nesm√≠ obsahovat mezery, lom√≠tka, nebo "http" (to by znamenalo ≈æe tam nƒõkdo cpe link)
                if (val.includes(' ') || val.includes('/') || val.includes('.' + type) || val.includes('http')) {
                    row.classList.add('invalid');
                } else {
                    row.classList.add('valid');
                }
            }
        }

        function toggleMode(btn) {
            const row = btn.closest('.active-social-row');
            const input = row.querySelector('.social-input');
            const type = input.getAttribute('data-type');
            
            row.classList.toggle('mode-url');
            btn.classList.toggle('active');

            if (row.classList.contains('mode-url')) {
                input.placeholder = "https://...";
            } else {
                input.placeholder = "username";
            }
            input.focus();
            validateRow(row, input.value, type); // Znovu validovat po p≈ôepnut√≠
        }

        function testSocialLink(btn, type) {
            const row = btn.closest('.active-social-row');
            const input = row.querySelector('.social-input');
            const val = input.value.trim();
            if(!val) { alert("Vypl≈à pol√≠ƒçko."); return; }

            let finalUrl;
            if (row.classList.contains('mode-url')) {
                finalUrl = val;
                if(!finalUrl.startsWith('http')) finalUrl = 'https://' + finalUrl;
            } else {
                finalUrl = platforms[type].url + val.replace('@', '');
            }
            window.open(finalUrl, '_blank');
        }

        // --- Zbytek logiky (Load/Save atd.) ---
        const themes = [
            { id: "spring-morning", name: "Jaro R√°no", bg: "#f3ffe3" }, { id: "spring-noon", name: "Jaro Poledne", bg: "#badc58" },
            { id: "spring-evening", name: "Jaro Veƒçer", bg: "#e056fd", dark:true }, { id: "spring-night", name: "Jaro Noc", bg: "#2c3a47", dark:true },
            { id: "summer-morning", name: "L√©to R√°no", bg: "#81ecec" }, { id: "summer-noon", name: "L√©to Poledne", bg: "#f9ca24" },
            { id: "summer-evening", name: "L√©to Veƒçer", bg: "#eb4d4b", dark:true }, { id: "summer-night", name: "L√©to Noc", bg: "#130f40", dark:true },
            { id: "autumn-morning", name: "Podzim R√°no", bg: "#d1ccc0" }, { id: "autumn-noon", name: "Podzim Poledne", bg: "#ffdbcc" },
            { id: "autumn-evening", name: "Podzim Veƒçer", bg: "#e17055", dark:true }, { id: "autumn-night", name: "Podzim Noc", bg: "#2d3436", dark:true },
            { id: "winter-morning", name: "Zima R√°no", bg: "#dfe4ea" }, { id: "winter-noon", name: "Zima Poledne", bg: "#bbdefb" },
            { id: "winter-evening", name: "Zima Veƒçer", bg: "#a29bfe", dark:true }, { id: "winter-night", name: "Zima Noc", bg: "#0c2461", dark:true }
        ];

        const themeContainer = document.getElementById('themeGrid');
        themes.forEach(t => {
            const div = document.createElement('div');
            div.className = 'theme-btn' + (t.dark ? ' dark-text' : '');
            div.innerText = t.name; div.style.background = t.bg;
            div.onclick = () => selectTheme(t.id, div);
            themeContainer.appendChild(div);
        });

        function selectTheme(id, el) {
            document.getElementById('selectedTheme').value = id;
            document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            document.body.className = ''; 
            const parts = id.split('-'); document.body.classList.add(parts[0]); document.body.classList.add(parts[1]);
        }

        const seeds = ["Leo", "Mila", "Caleb", "Eliza", "Chase", "Jade", "Nora", "Jack", "Felix", "Ruby"];
        const avContainer = document.getElementById('avatarStudio');
        seeds.forEach(s => {
            const img = document.createElement('img');
            const url = `https://api.dicebear.com/7.x/notionists/svg?seed=${s}&backgroundColor=transparent`;
            img.src = url; img.className = 'avatar-option';
            img.onclick = () => {
                document.getElementById('base64String').value = url;
                document.getElementById('preview').src = url;
                document.querySelectorAll('.avatar-option').forEach(x => x.classList.remove('selected'));
                img.classList.add('selected');
            };
            avContainer.appendChild(img);
        });

        const linksWrapper = document.getElementById('linksContainer');
        function addLinkField(l="", u="") {
            const d = document.createElement('div'); d.className = 'link-row';
            d.innerHTML = `<input class="admin-input l-lbl" placeholder="N√°zev" value="${l}" style="width:40%"> <input class="admin-input l-url" placeholder="URL" value="${u}" style="width:60%"> <i class="fas fa-times remove-social" style="margin-top:10px;" onclick="this.parentElement.remove()"></i>`;
            linksWrapper.appendChild(d);
        }

        async function saveCard() {
            const stat = document.getElementById('status'); stat.innerText = "Ukl√°d√°m...";
            const slug = document.getElementById('slug').value.toLowerCase().replace(/\s+/g, '-');
            const links = [];

            document.querySelectorAll('.active-social-row').forEach(row => {
                const input = row.querySelector('.social-input');
                const type = input.getAttribute('data-type');
                let val = input.value.trim();
                
                if(val) {
                    let finalUrl;
                    if (row.classList.contains('mode-url')) {
                        finalUrl = val;
                        if(!finalUrl.startsWith('http')) finalUrl = 'https://' + finalUrl;
                    } else {
                        finalUrl = platforms[type].url + val.replace('@', ''); 
                    }
                    links.push({ label: platforms[type].label, url: finalUrl });
                }
            });

            document.querySelectorAll('.link-row').forEach(r => {
                const l = r.querySelector('.l-lbl').value; const u = r.querySelector('.l-url').value;
                if(l && u) links.push({label: l, url: u});
            });

            const payload = {
                data: {
                    slug: slug, name: document.getElementById('name').value,
                    bio: document.getElementById('bio').value, motto: document.getElementById('motto').value,
                    theme: document.getElementById('selectedTheme').value,
                    avatar: document.getElementById('base64String').value, links: links
                }
            };

            try {
                await fetch('/api/aeon-api', { method: 'POST', body: JSON.stringify(payload) });
                stat.innerText = "HOTOVO!"; stat.style.color = "#0f0";
                setTimeout(() => window.location.href = `/?slug=${slug}`, 1500);
            } catch(e) { stat.innerText = "CHYBA"; }
        }

        window.onload = async function() {
            const params = new URLSearchParams(window.location.search);
            const slug = params.get('slug');
            if(slug) {
                document.getElementById('slug').value = slug;
                document.getElementById('saveBtn').innerText = "AKTUALIZOVAT";
                try {
                    const res = await fetch(`/api/aeon-api?slug=${slug}`);
                    if(res.ok) {
                        const d = await res.json();
                        document.getElementById('name').value = d.name || "";
                        document.getElementById('bio').value = d.bio || "";
                        document.getElementById('motto').value = d.motto || "";
                        
                        if(d.theme) {
                            const btn = Array.from(document.querySelectorAll('.theme-btn')).find(b => b.innerText.includes(d.theme.split('-')[1].charAt(0).toUpperCase())); 
                            selectTheme(d.theme, btn || document.createElement('div'));
                        } else { selectTheme('winter-night', document.createElement('div')); }

                        if(d.avatar) { document.getElementById('base64String').value = d.avatar; document.getElementById('preview').src = d.avatar; }
                        
                        activeSocialsDiv.innerHTML = '';
                        linksWrapper.innerHTML = '';
                        
                        if(d.links) {
                            d.links.forEach(x => {
                                let found = false;
                                for (const [key, p] of Object.entries(platforms)) {
                                    if (x.url.startsWith(p.url)) {
                                        const username = x.url.replace(p.url, '');
                                        addSocial(key, username, false);
                                        found = true;
                                        break;
                                    } else if (x.url.includes(key) || (key==='twitter' && x.url.includes('x.com'))) {
                                        addSocial(key, x.url, true);
                                        found = true;
                                        break;
                                    }
                                }
                                if (!found) addLinkField(x.label, x.url);
                            });
                        }
                    }
                } catch(e){}
            } else { selectTheme('winter-night', document.createElement('div')); }
            document.getElementById('loading').style.display = 'none';
        }

        document.getElementById('photoInput').addEventListener('change', function(e) {
            const file = e.target.files[0]; if(!file) return;
            const r = new FileReader();
            r.onload = function(ev) {
                const i = new Image(); i.onload = function() {
                    const c = document.createElement('canvas'); const x = c.getContext('2d');
                    const m = 500; let w=i.width, h=i.height;
                    if(w>h){if(w>m){h*=m/w;w=m}}else{if(h>m){w*=m/h;h=m}}
                    c.width=w; c.height=h; x.drawImage(i,0,0,w,h);
                    const d = c.toDataURL('image/jpeg',0.8);
                    document.getElementById('preview').src=d; document.getElementById('base64String').value=d;
                }; i.src = ev.target.result;
            }; r.readAsDataURL(file);
        });
    </script>
</body>
</html>